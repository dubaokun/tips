# 👊 总结

点子都是来自于大家，我将大家出的一个个点子汇总，加以发酵做个简单总结。

## 福卡池

首先，任何公司举办活动肯定都有奖池。

那么我相信福卡池也一定有奖池。那么根据集齐5福才能召唤神龙的规则。

也就是说，其他的福卡可以是以一定的策略随机+每日限额。

但是有一种福卡是严格按照总量控制的，这里叫他`关键福`。

那么，抽福卡的流程是：

- 根据当前概率抽卡，命中则下一步，不命中则返回没有抽到卡
- 做带权重的抽签，确定本次抽到哪一种福卡。如果是非关键福则返回抽中福卡。如果是关键福，则下一步。
- 去今日投放的关键福资源池里获取资源，如果获取到则总资源-1，如果获取不到则返回未抽中。

## 数据存储

按照@wangguixi的算法，我们用Redis得hashes数据结构存储福卡数据。简单计算下需要内存容量。

假设：5亿玩家，每种福卡每人不超过10个。

每个玩家的数据是这样的
- userId
 - A:1
 - B:1
 - C:1
 - D:1
 - E:1

这里忽略redis hashes数据结构本身需要占用的字节。同时，useId我们计16个字节。

16 + 10 = 26 byte

26 * 500000000 = 13,000,000,000 byte ≈ 12.2 Gbyte

这个内存占用完全可以接受。

我们对用户做一致性hash，分片到不同的Redis服务器。一方面将数据打散，减少出错的概率，避免单点。另一方面将压力分散到不同的节点。

## 福卡流转

这个系统的难点，应该是对关键福做精确的数量控制。比如总量100个，那么一个人从100中获取到一个，总量减一变成99.那获取到的1一定要保证加到那个人头上。

这中间涉及到数据一致性的问题。类似转账。

未完待续。。。
